sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/MessageBox","webjavasapui5/model/models"],(e,t,s,o,a)=>{"use strict";return e.extend("webjavasapui5.controller.DetailPage",{onInit(){const e=this.getOwnerComponent().getRouter();const t=e.getRoute("RouteDetailPage");t.attachPatternMatched(this._onRouteMatched,this);const s=a.createUserInfoModel(this.getOwnerComponent());this.getView().setModel(s,"userInfo");this._loadRolesAndDepartments()},handleEmpPress(){const e=this.getOwnerComponent().getRouter();const t=this.getView().getModel("i18n").getResourceBundle();const s=this.getView().getModel("userInfo");if(s&&s.getProperty("/roles/admin")){sap.m.MessageBox.confirm(t.getText("confirmCancelMessage"),{title:t.getText("confirmCancelTitle"),actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:t=>{if(t===sap.m.MessageBox.Action.YES){e.navTo("RouteListPage");this._clearForm()}}})}else{e.navTo("RouteListPage")}},handleAddPress(){const e=this.getView().getModel("i18n").getResourceBundle();const t=this.getOwnerComponent().getRouter();const s=this.getView().getModel("userInfo");if(s&&s.getProperty("/roles/admin")){sap.m.MessageBox.confirm(e.getText("confirmCancelMessage"),{title:e.getText("confirmCancelTitle"),actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:e=>{if(e===sap.m.MessageBox.Action.YES){t.navTo("RouteDetailPage",{employeeId:"new"})}}})}},onSave(){const e=this.getView().getModel("employee");const t=e.getData();if(!this._validateForm(t)){return}const s=this.getView().getModel("i18n").getResourceBundle();o.confirm(s.getText("confirmSaveMessage"),{title:s.getText("confirmSaveTitle"),onClose:e=>{if(e===o.Action.OK){this._performSave(t)}}})},_performSave(e){const t=this.getOwnerComponent().getModel();const o=this.getView().getModel("i18n").getResourceBundle();const a={firstName:e.firstName,lastName:e.lastName,dateOfBirth:e.dateOfBirth,email:e.email,department_ID:e.department_ID,role_ID:e.role_ID,hireDate:this._formatDate(e.hireDate)};if(e.isEditMode&&e.ID){const n=`/Employees(${e.ID})`;const r=t.bindContext(n);r.requestObject().then(()=>{const e=r.getBoundContext();Object.keys(a).forEach(t=>{e.setProperty(t,a[t])});return t.submitBatch(t.getUpdateGroupId())}).then(()=>{s.show(o.getText("employeeUpdatedMessage"));this._clearForm();this._navigateListViewWithRefresh()}).catch(e=>{s.show(o.getText("errorUpdatingMessage"))})}else{const e=t.bindList("/Employees");try{const t=e.create(a);t.created().then(()=>{s.show(o.getText("employeeCreatedMessage"));this._clearForm();this._navigateListViewWithRefresh()}).catch(e=>{s.show(o.getText("errorCreatingMessage"))})}catch(e){s.show(o.getText("errorCreatingMessage"))}}},onEmailChange(e){const t=e.getParameter("value");const s=e.getSource();const o=this.getView().getModel("i18n").getResourceBundle();if(t===""){s.setValueState("None");s.setValueStateText("");return}const a=/^\w+[\w-+\.]*\@\w+([-\.]\w+)*\.[a-zA-Z]{2,}$/;if(a.test(t)){s.setValueState("Success");s.setValueStateText(o.getText("validEmailAddress"))}else{s.setValueState("Error");s.setValueStateText(o.getText("validationInvalidEmail"))}},onHireDateChange(e){this._calculateAndPreviewSalary()},onRoleChange(){this._calculateAndPreviewSalary()},onCancel(){this.handleEmpPress()},_validateForm(e){const t=this.getView().getModel("i18n").getResourceBundle();if(!e.firstName||!e.lastName||!e.email||!e.department_ID||!e.role_ID||!e.hireDate){s.show(t.getText("validationRequiredFields"));return false}const o=/^\w+[\w-+\.]*\@\w+([-\.]\w+)*\.[a-zA-Z]{2,}$/;if(e.email&&!o.test(e.email)){s.show(t.getText("validationInvalidEmail"));return false}return true},_navigateListView(){const e=this.getOwnerComponent().getRouter();e.navTo("RouteListPage");setTimeout(()=>{const e=this.getOwnerComponent().getModel();const t=e.bindList("/Employees");if(t){t.refresh()}},100)},_navigateListViewWithRefresh(){const e=this.getOwnerComponent().getRouter();const t=sap.ui.getCore().getEventBus();t.publish("employee","dataChanged",{});e.navTo("RouteListPage")},_onRouteMatched(e){this._refreshEmailState();const t=e.getParameter("arguments");const s=t.employeeId;if(s&&s!=="new"){this._loadEmployeeData(s)}else{const e=this.getView().getModel("select");if(e&&e.getProperty("/departments")){this._createEmpModel()}else{this._createEmpModel()}}},_createEmpModel(e=null){const s=this.getView().getModel("select");let o="";let a="";if(s){const e=s.getProperty("/departments");if(e&&e.length>0){o=e[0].key}const t=s.getProperty("/roles");if(t&&t.length>0){a=t[0].key}}var n={firstName:"",lastName:"",email:"",department_ID:o,role_ID:a,salary:0,hireDate:"",dateOfBirth:"",isEditMode:false};var r=Object.assign({},n);if(e){r={ID:e.ID,firstName:e.firstName||"",lastName:e.lastName||"",email:e.email||"",department_ID:e.department_ID||o,role_ID:e.role_ID||a,salary:e.salary||0,hireDate:e.hireDate||"",dateOfBirth:e.dateOfBirth||"",isEditMode:true}}var i=new t(r);i.setDefaultBindingMode("TwoWay");this.getView().setModel(i,"employee");if(e||r.role_ID&&r.hireDate){setTimeout(()=>{this._calculateAndPreviewSalary()},200)}return i},_refreshEmailState(){const e=this.getView().byId("emailInput");if(e){e.setValueState(sap.ui.core.ValueState.None);e.setValueStateText("")}},_loadEmployeeData(e){const t=this.getOwnerComponent().getModel();const o=`/Employees(${e})`;const a=t.bindContext(o,null,{$expand:"department,role"});a.requestObject().then(e=>{this._createEmpModel(e)}).catch(e=>{const t=this.getView().getModel("i18n").getResourceBundle();s.show(t.getText("errorLoadingEmployee"));this._createEmpModel()})},_loadRolesAndDepartments(){const e=this.getOwnerComponent().getModel();const s=new t({});this.getView().setModel(s,"select");const o=e.bindList("/Roles");o.requestContexts().then(e=>{const t=e.map(e=>e.getObject());const o=[];t.forEach(e=>{o.push({key:e.ID||e.id,text:e.name||e.Name})});s.setProperty("/roles",o);const a=this.getView().getModel("employee");if(a&&o.length>0){const e=a.getProperty("/role_ID");if(!e){a.setProperty("/role_ID",o[0].key);setTimeout(()=>{this._calculateAndPreviewSalary()},100)}}}).catch(e=>{});const a=e.bindList("/Departments");a.requestContexts().then(e=>{const t=e.map(e=>e.getObject());const o=[];t.forEach(e=>{o.push({key:e.ID||e.id,text:e.name||e.Name})});s.setProperty("/departments",o);const a=this.getView().getModel("employee");if(a&&o.length>0){const e=a.getProperty("/department_ID");if(!e){a.setProperty("/department_ID",o[0].key)}}}).catch(e=>{})},_formatDate(e){if(!e)return"";try{if(/^\d{4}-\d{2}-\d{2}$/.test(e)){return e}const t=new Date(e);if(isNaN(t.getTime())){return""}const s=t.getFullYear();const o=String(t.getMonth()+1).padStart(2,"0");const a=String(t.getDate()).padStart(2,"0");return`${s}-${o}-${a}`}catch(e){return""}},_clearForm(){this._createEmpModel()},_calculateAndPreviewSalary(){const e=this.getView().getModel("employee");if(!e){return}const t=e.getProperty("/role_ID");const s=e.getProperty("/hireDate");if(!t||!s){e.setProperty("/salary",0);return}const o=this.getOwnerComponent().getModel();const a=`/Roles(${t})`;const n=o.bindContext(a);n.requestObject().then(t=>{if(t&&t.baseSalary){const o=new Date(s);const a=new Date;const n=a.getFullYear()-o.getFullYear();const r=1e3;const i=n*r;const l=parseFloat(t.baseSalary);const c=l+i;e.setProperty("/salary",c)}}).catch(t=>{e.setProperty("/salary",0)})}})});
//# sourceMappingURL=DetailPage.controller.js.map