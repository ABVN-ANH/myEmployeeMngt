sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/MessageBox","webjavasapui5/model/models"],(e,t,o,s,a)=>{"use strict";function n(e){if(!e)return"";if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;const t=new Date(e);if(isNaN(t.getTime()))return"";return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}function r(e){return/^\w+[\w-+\.]*\@\w+([-\.]\w+)*\.[a-zA-Z]{2,}$/.test(e)}return e.extend("webjavasapui5.controller.DetailPage",{onInit(){const e=this.getOwnerComponent().getRouter();e.getRoute("RouteDetailPage").attachPatternMatched(this._onRouteMatched,this);this.getView().setModel(a.createUserInfoModel(this.getOwnerComponent()),"userInfo");this._loadRolesAndDepartments()},handleViewDetailEmployeePress(){const e=this.getOwnerComponent().getRouter();const t=this.getView().getModel("i18n").getResourceBundle();const o=this.getView().getModel("userInfo");if(o&&o.getProperty("/roles/admin")){s.confirm(t.getText("confirmCancelMessage"),{title:t.getText("confirmCancelTitle"),actions:[s.Action.YES,s.Action.NO],onClose:t=>{if(t===s.Action.YES){e.navTo("RouteListPage");this._clearForm()}}})}else{e.navTo("RouteListPage")}},handleCreateNewEmployeePress(){const e=this.getView().getModel("i18n").getResourceBundle();const t=this.getOwnerComponent().getRouter();const o=this.getView().getModel("userInfo");if(o&&o.getProperty("/roles/admin")){s.confirm(e.getText("confirmCancelMessage"),{title:e.getText("confirmCancelTitle"),actions:[s.Action.YES,s.Action.NO],onClose:e=>{if(e===s.Action.YES){t.navTo("RouteDetailPage",{employeeId:"new"})}}})}},handleSaveEmployeePress(){const e=this.getView().getModel("employee");const t=e.getData();if(!this._validateForm(t))return;const o=this.getView().getModel("i18n").getResourceBundle();s.confirm(o.getText("confirmSaveMessage"),{title:o.getText("confirmSaveTitle"),onClose:e=>{if(e===s.Action.OK){this._performSave(t)}}})},_performSave(e){const t=this.getOwnerComponent().getModel();const s=this.getView().getModel("i18n").getResourceBundle();const a={firstName:e.firstName,lastName:e.lastName,dateOfBirth:n(e.dateOfBirth),email:e.email,department_ID:e.department_ID,role_ID:e.role_ID,hireDate:n(e.hireDate)};if(e.isEditMode&&e.ID){const n=`/Employees(${e.ID})`;const r=t.bindContext(n);r.requestObject().then(()=>{const e=r.getBoundContext();Object.keys(a).forEach(t=>{e.setProperty(t,a[t])});return t.submitBatch(t.getUpdateGroupId())}).then(()=>{o.show(s.getText("employeeUpdatedMessage"));this._clearForm();this._navigateListViewWithRefresh()}).catch(()=>{o.show(s.getText("errorUpdatingMessage"))})}else{const e=t.bindList("/Employees");try{const t=e.create(a);t.created().then(()=>{o.show(s.getText("employeeCreatedMessage"));this._clearForm();this._navigateListViewWithRefresh()}).catch(()=>{o.show(s.getText("errorCreatingMessage"))})}catch(e){o.show(s.getText("errorCreatingMessage"))}}},onEmailChange(e){const t=e.getParameter("value");const o=e.getSource();const s=this.getView().getModel("i18n").getResourceBundle();if(t===""){o.setValueState("None");o.setValueStateText("");return}if(r(t)){o.setValueState("Success");o.setValueStateText(s.getText("validEmailAddress"))}else{o.setValueState("Error");o.setValueStateText(s.getText("validationInvalidEmail"))}},onHireDateChange(){this._calculateAndPreviewSalary()},onRoleChange(){this._calculateAndPreviewSalary()},handleCancelEmployeePress(){this.handleViewDetailEmployeePress()},_validateForm(e){const t=this.getView().getModel("i18n").getResourceBundle();if(!e.firstName||!e.lastName||!e.email||!e.department_ID||!e.role_ID||!e.hireDate){o.show(t.getText("validationRequiredFields"));return false}if(e.email&&!r(e.email)){o.show(t.getText("validationInvalidEmail"));return false}return true},_navigateListView(){const e=this.getOwnerComponent().getRouter();e.navTo("RouteListPage");setTimeout(()=>{const e=this.getOwnerComponent().getModel();const t=e.bindList("/Employees");if(t)t.refresh()},100)},_navigateListViewWithRefresh(){const e=this.getOwnerComponent().getRouter();sap.ui.getCore().getEventBus().publish("employee","dataChanged",{});e.navTo("RouteListPage")},_onRouteMatched(e){this._refreshEmailState();const t=e.getParameter("arguments");const o=t.employeeId;if(o&&o!=="new"){this._loadEmployeeData(o)}else{this._createEmpModel()}},_createEmpModel(e=null){const o=this.getView().getModel("select");let s="";let a="";if(o){const e=o.getProperty("/departments");if(e&&e.length>0)s=e[0].key;const t=o.getProperty("/roles");if(t&&t.length>0)a=t[0].key}const n={firstName:"",lastName:"",email:"",department_ID:s,role_ID:a,salary:0,hireDate:"",dateOfBirth:"",isEditMode:false};let r=Object.assign({},n);if(e){r={ID:e.ID,firstName:e.firstName||"",lastName:e.lastName||"",email:e.email||"",department_ID:e.department_ID||s,role_ID:e.role_ID||a,salary:e.salary||0,hireDate:e.hireDate||"",dateOfBirth:e.dateOfBirth||"",isEditMode:true}}const i=new t(r);i.setDefaultBindingMode("TwoWay");this.getView().setModel(i,"employee");if(e||r.role_ID&&r.hireDate){setTimeout(()=>this._calculateAndPreviewSalary(),200)}return i},_refreshEmailState(){const e=this.getView().byId("emailInput");if(e){e.setValueState(sap.ui.core.ValueState.None);e.setValueStateText("")}},_loadEmployeeData(e){const t=this.getOwnerComponent().getModel();const s=`/Employees(${e})`;const a=t.bindContext(s,null,{$expand:"department,role"});a.requestObject().then(e=>{this._createEmpModel(e)}).catch(()=>{o.show(this.getView().getModel("i18n").getResourceBundle().getText("errorLoadingEmployee"));this._createEmpModel()})},_loadRolesAndDepartments(){const e=this.getOwnerComponent().getModel();const o=new t({});this.getView().setModel(o,"select");e.bindList("/Roles").requestContexts().then(e=>{const t=e.map(e=>{const t=e.getObject();return{key:t.ID||t.id,text:t.name||t.Name}});o.setProperty("/roles",t);const s=this.getView().getModel("employee");if(s&&t.length>0&&!s.getProperty("/role_ID")){s.setProperty("/role_ID",t[0].key);setTimeout(()=>this._calculateAndPreviewSalary(),100)}});e.bindList("/Departments").requestContexts().then(e=>{const t=e.map(e=>{const t=e.getObject();return{key:t.ID||t.id,text:t.name||t.Name}});o.setProperty("/departments",t);const s=this.getView().getModel("employee");if(s&&t.length>0&&!s.getProperty("/department_ID")){s.setProperty("/department_ID",t[0].key)}})},_clearForm(){this._createEmpModel()},_calculateAndPreviewSalary(){const e=this.getView().getModel("employee");if(!e)return;const t=e.getProperty("/role_ID");const o=e.getProperty("/hireDate");if(!t||!o){e.setProperty("/salary",0);return}const s=this.getOwnerComponent().getModel();const a=`/Roles(${t})`;const n=s.bindContext(a);n.requestObject().then(t=>{if(t&&t.baseSalary){const s=new Date(o);const a=new Date;const n=a.getFullYear()-s.getFullYear();const r=parseFloat(t.baseSalary)+n*1e3;e.setProperty("/salary",r)}}).catch(()=>{e.setProperty("/salary",0)})}})});
//# sourceMappingURL=DetailPage.controller.js.map